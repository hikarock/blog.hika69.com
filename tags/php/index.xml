<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Php on hikarock blog</title>
    <link>https://blog.hika69.com/tags/php/</link>
    <description>Recent content in Php on hikarock blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <copyright>All rights reserved - 2015</copyright>
    <lastBuildDate>Fri, 25 Nov 2016 17:49:12 +0900</lastBuildDate>
    <atom:link href="https://blog.hika69.com/tags/php/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>開発環境に Phan を導入した</title>
      <link>https://blog.hika69.com/blog/2016/11/25/phan/</link>
      <pubDate>Fri, 25 Nov 2016 17:49:12 +0900</pubDate>
      
      <guid>https://blog.hika69.com/blog/2016/11/25/phan/</guid>
      <description>

&lt;p&gt;開発環境 (Mac) で PHP の静的解析がしたくて Phan を導入した。&lt;/p&gt;

&lt;p&gt;さくっといけるかと思いきやいろいろつまづいたので備忘。&lt;/p&gt;

&lt;h3 id=&#34;参考:593646a7e5561d464cbb25a13a7e3164&#34;&gt;参考&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/etsy/phan&#34;&gt;etsy/phan: Static analyzer for PHP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://inside.pixiv.net/entry/2016/11/11/202656&#34;&gt;Phan静的解析がもたらす大PHP型検査時代 - pixiv inside&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&#34;php7-を準備:593646a7e5561d464cbb25a13a7e3164&#34;&gt;PHP7 を準備&lt;/h3&gt;

&lt;p&gt;phan が要求する PHP7 を導入する。今回は PHP5.6 も同居させたいので phpbrew を使う。&lt;/p&gt;

&lt;p&gt;以下のエントリが参考になった。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.karakaram.com/mac-install-phpbrew&#34;&gt;MacでのPHP開発はphpbrewが非常に良い | karakaram-blog&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&#34;phpbrew-をインストール:593646a7e5561d464cbb25a13a7e3164&#34;&gt;phpbrew をインストール&lt;/h4&gt;

&lt;p&gt;以下のドキュメントを見つつ進める。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/phpbrew/phpbrew#install&#34;&gt;phpbrew/phpbrew#install&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;phpbrew をダウンロードしてパスの通ったところに配置する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% curl -L -O https://github.com/phpbrew/phpbrew/raw/master/phpbrew
% chmod +x phpbrew
% mv phpbrew ~/bin/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;初期設定のコマンドを実行。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew init
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;.zshrc&lt;/code&gt; に以下の記述を追記。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;if [ -d ${HOME}/.phpbrew ]; then
  source $HOME/.phpbrew/bashrc
fi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;利用可能なPHPのバージョンを調べる。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew known
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;7系で最新のバージョンをインストールする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew install 7.0.13 +default
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ちなみに 5.3.x のような古いバージョンを入れたい時は &lt;code&gt;--old&lt;/code&gt; オプションで表示される。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew known --old
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;インストールが完了したらバージョンを切り替える。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew switch php-7.0.13
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;phan-をインストール:593646a7e5561d464cbb25a13a7e3164&#34;&gt;phan をインストール&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/etsy/phan/wiki/Getting-Started#from-phanphar&#34;&gt;Getting Started · etsy/phan Wiki&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;ldquo;From Phan.phar&amp;rdquo; の手順で進める。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% curl -L https://github.com/etsy/phan/releases/download/0.6/phan.phar -o phan.phar;
% mv phan.phar ~/bin
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;http://inside.pixiv.net/entry/2016/11/11/202656&#34;&gt;pixiv さんのエントリ&lt;/a&gt; を参考に、以下のスクリプトを、パスの通ったところに設置する。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;#!/bin/sh

/Users/hikarock/.phpbrew/php/php-7.0.13/bin/php ${PHAN_BIN:-/Users/hikarock/bin/phan.phar} &amp;quot;$@&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;php-ast-をインストール:593646a7e5561d464cbb25a13a7e3164&#34;&gt;php-ast をインストール&lt;/h3&gt;

&lt;p&gt;phan が依存している php-ast をインストールする。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/nikic/php-ast#installation&#34;&gt;nikic/php-ast: Extension exposing PHP 7 abstract syntax tree&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;% git clone git@github.com:nikic/php-ast.git
% cd php-ast
% phpize
% ./configure
% make
% sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;php -i | grep extension_dir&lt;/code&gt; などで extension のインストール先を確認して、該当ディレクトリに &lt;code&gt;ast.so&lt;/code&gt; が配置されていることを確認。&lt;/p&gt;

&lt;p&gt;ちなみに以下に配置されていた。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% pwd
/Users/hikarock/.phpbrew/php/php-7.0.13/lib/php/extensions/no-debug-non-zts-20151012
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;php.ini の &lt;code&gt;[php]&lt;/code&gt; 配下に以下を追記して extension を読み込む。php.ini の場所は &lt;code&gt;php --ini&lt;/code&gt; で確認する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;extension = &amp;quot;ast.so&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;足りてなかった-extension-を追加:593646a7e5561d464cbb25a13a7e3164&#34;&gt;足りてなかった extension を追加&lt;/h3&gt;

&lt;p&gt;phan が依存している &lt;code&gt;sqlite3&lt;/code&gt; が足りていなかったので phpbrew で追加する&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% phpbrew ext install sqlite3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここでようやく phan コマンドが正常動作した。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;phan -h
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;phan-config-php-の設置:593646a7e5561d464cbb25a13a7e3164&#34;&gt;.phan/config.php の設置&lt;/h3&gt;

&lt;p&gt;静的解析を行いたいプロジェクトのディレクトリ直下に &lt;code&gt;.phan/config.php&lt;/code&gt; を作成する。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
return [
    // 解析対象のディレクトリ
    &#39;directory_list&#39; =&amp;gt; [
        &#39;lib/&#39;
    ],
    // 解析対象外のディレクトリ
    &#39;exclude_analysis_directory_list&#39; =&amp;gt; [
        &#39;vendor/&#39;
    ],
];
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;実行する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;% cd /path/to/project
% phan --progress-bar -ophan.log
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;大量の解析結果が &lt;code&gt;phan.log&lt;/code&gt; に出力された。めでたしめでたし。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>PSR-2 の最終行の空行についての規約を勘違いしていた</title>
      <link>https://blog.hika69.com/blog/2016/05/20/psr-2-single-blank-line/</link>
      <pubDate>Fri, 20 May 2016 23:29:22 +0900</pubDate>
      
      <guid>https://blog.hika69.com/blog/2016/05/20/psr-2-single-blank-line/</guid>
      <description>&lt;p&gt;PHP の &lt;a href=&#34;http://www.php-fig.org/psr/psr-2/&#34;&gt;PSR-2&lt;/a&gt; で「最終行に空行を入れる」という規約がある。&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;All PHP files MUST end with a single blank line.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;この規約に従っていたつもりなんだけど、勘違いしていたことがわかった&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:068fbfaf1d29160431985fc269a051fe:1&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:068fbfaf1d29160431985fc269a051fe:1&#34;&gt;1&lt;/a&gt;&lt;/sup&gt;ので備忘。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://firegoby.jp/archives/2391&#34;&gt;UNIXの行の定義とviの改行コード | Firegoby&lt;/a&gt; より引用&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;POSIXでは「Unix においてテキストファイルとは行の集合であり、行とは改行文字で終わるものと定義される」と定義されている。&lt;/p&gt;

&lt;p&gt;viのような由緒正しきテキストエディターは、この定義を忠実に守っており、行末には必ず改行が入る仕様になっている。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;このため Vim で最終行に &lt;strong&gt;空行が見える&lt;/strong&gt; ように記述している場合、最終行に改行が連続(LFLF)して入力されている。&lt;/p&gt;

&lt;p&gt;GitHub でも最終行の空行は表示されない&lt;sup class=&#34;footnote-ref&#34; id=&#34;fnref:068fbfaf1d29160431985fc269a051fe:2&#34;&gt;&lt;a rel=&#34;footnote&#34; href=&#34;#fn:068fbfaf1d29160431985fc269a051fe:2&#34;&gt;2&lt;/a&gt;&lt;/sup&gt;。PSR-2 の規約を満たしていても、Vim と GitHub では空行が見えないため、空行を連続して入力してしまっていた。&lt;/p&gt;

&lt;p&gt;ということで PSR-2 に従う場合、Vim では最終行の &lt;strong&gt;空行が見えない状態が正解&lt;/strong&gt; のようだ。&lt;/p&gt;
&lt;div class=&#34;footnotes&#34;&gt;

&lt;hr /&gt;

&lt;ol&gt;
&lt;li id=&#34;fn:068fbfaf1d29160431985fc269a051fe:1&#34;&gt;発端はプロジェクトの新メンバーのエディタが Atom で、僕が Vim だったため表示が違ったこと
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:068fbfaf1d29160431985fc269a051fe:1&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;li id=&#34;fn:068fbfaf1d29160431985fc269a051fe:2&#34;&gt;GitHub の表示については PHP-FIG のメンバーである &lt;a href=&#34;https://github.com/cakephp/cakephp/blob/master/src/Collection/Collection.php#L101&#34;&gt;CakePHP&lt;/a&gt; や &lt;a href=&#34;https://github.com/drupal/drupal/blob/8.1.x/core/lib/Drupal.php#L724&#34;&gt;Drual&lt;/a&gt; の .php ファイルの最終行の表示を確認した。
 &lt;a class=&#34;footnote-return&#34; href=&#34;#fnref:068fbfaf1d29160431985fc269a051fe:2&#34;&gt;&lt;sup&gt;[return]&lt;/sup&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>スネークケースのファイル名・クラス名をパスカルケースにリネームする</title>
      <link>https://blog.hika69.com/blog/2016/01/07/rename-snake-case-to-pascal-case/</link>
      <pubDate>Thu, 07 Jan 2016 21:46:22 +0900</pubDate>
      
      <guid>https://blog.hika69.com/blog/2016/01/07/rename-snake-case-to-pascal-case/</guid>
      <description>

&lt;p&gt;あるプロジェクトで &lt;a href=&#34;http://www.php-fig.org/psr/psr-0/&#34;&gt;PSR-0&lt;/a&gt; に対応する作業に関連して、スネークケースのファイル名とクラス名をパスカルケースに変換する必要があった。&lt;/p&gt;

&lt;h3 id=&#34;ファイル名の変換:4739118768bed0d63c3796c5bfa8d06b&#34;&gt;ファイル名の変換&lt;/h3&gt;

&lt;p&gt;Mac に rename コマンドをインストールする。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ brew install rename
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;変換前&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -l
-rw-r--r-- 1 hikarock staff 0  1  7 21:47 foo_bar_buzz.php
-rw-r--r-- 1 hikarock staff 0  1  7 21:47 hoge_fuga.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rename コマンドを叩く。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ rename -f &#39;s/(^|_)(.)/\U$2\E/g&#39; *.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;変換後&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ ls -l
total 0
-rw-r--r-- 1 hikarock staff 0  1  7 21:47 FooBarBuzz.php
-rw-r--r-- 1 hikarock staff 0  1  7 21:47 HogeFuga.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;よさそう。&lt;/p&gt;

&lt;h3 id=&#34;クラス名の変換:4739118768bed0d63c3796c5bfa8d06b&#34;&gt;クラス名の変換&lt;/h3&gt;

&lt;p&gt;Mac に標準で入っている sed は使わずに GNU sed をインストールする。&lt;/p&gt;

&lt;p&gt;参考: &lt;a href=&#34;http://shunirr.hatenablog.jp/entry/2012/12/19/160544&#34;&gt;Homebrew を使って OSX に GNU sed を入れる - おともだちティータイム&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ brew install gnu-sed
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;変換前。対象はクラス名だけにしたいので、他のスネークケースの変数名や関数名を含んだ状態で、余計な箇所が変更されていないか確認しながら検証する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;?php

class foo_bar_buzz_controller extends bar_buzz_controller {
  private $hoge_fuga;
  public function set_hoge_fuga() {
    //
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;gsed コマンドで変換する。&lt;code&gt;/^class.*\{$/&lt;/code&gt; で対象行でクラス宣言の行だけに絞り込んでいる ( &lt;code&gt;{&lt;/code&gt; は改行した次の行に書く場合の方が多いかもしれないけど、このプロジェクトでは &lt;code&gt;class&lt;/code&gt; と同一行に書いている)。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;$ gsed -i -r &#39;/^class.*\{$/ s/_(.)/\U\1\E/g&#39; *.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;変換後&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;?php

class fooBarBuzzController extends barBuzzController {
  private $hoge_fuga;
  public function set_hoge_fuga() {
    //
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;クラス名の先頭が小文字のままだった。&lt;/p&gt;

&lt;p&gt;今回はたまたま対象クラス名の末尾に必ず &lt;code&gt;Controller&lt;/code&gt; が含まれていたので、以下のようにしてお茶を濁した。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ perl -pi -e &#39;s/ (\w+?)Controller/ \u\1Controller/g&#39; *.php
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;perl コマンドを使ったのは sed で最短一致ができなかったため。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;?php

class FooBarBuzzController extends BarBuzzController {
  private $hoge_fuga;
  public function set_hoge_fuga() {
    //
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;完了。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>